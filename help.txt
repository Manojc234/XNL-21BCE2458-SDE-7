import React, { useState, useEffect } from 'react';
import { Save, Send, FileText} from 'lucide-react';
import InstructionDetails from './InstructionDetails';
import PaymentDetailsTable from './PaymentDetailsTable';
import DraftManagement from './DraftManagement';
import { saveDraftToStorage } from '../utils/draftUtils';
import styles from "../Styles/Payroll.module.css";

// ✅ dynamically load bootstrap only for this component
const useScopedBootstrap = () => {
  useEffect(() => {
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css";
    link.id = "bootstrap-paymentform";
    document.head.appendChild(link);

    return () => {
      const existing = document.getElementById("bootstrap-paymentform");
      if (existing) existing.remove();
    };
  }, []);
};

const PaymentForm = () => {
  const ROWS_PER_PAGE = 10;
  useScopedBootstrap(); // ✅ bootstrap only active while this component is mounted

  const [instructionDetails, setInstructionDetails] = useState({
    paymentCurrency: '',
    debitAccount: '',
    valueDate: new Date().toISOString().split('T')[0]
  });

  const [rows, setRows] = useState([{
    paymentMethod: '',
    payeeDetails: '',
    payeeNature: '',
    bankDetails: '',
    yourReference: '',
    paymentReference: '',
    amount: '',
    notesToPayee: '',
    additionalNotes: ''
  }]);

  const [currentPage, setCurrentPage] = useState(1);
  const [errors, setErrors] = useState({ instruction: {}, rows: [] });
  const [showDrafts, setShowDrafts] = useState(false);

  // ... ⚡ keep all your handlers (updateRow, addRow, removeRow, etc.) exactly as you wrote them ...

  return (
    <div className="min-vh-100 bg-light">
      {showDrafts ? (
        <DraftManagement
          onEditDraft={handleEditDraft}
          onBackToCreate={() => setShowDrafts(false)}
        />
      ) : (
        <div className={`${styles.payrollContainer} bootstrap-scope`}>
          <div className={styles.content}>
            <div className="container-fluid px-4">
              <div className="mb-4 mt-3">
                <div className="d-flex justify-content-between align-items-center">
                  <h1 className="h2 fw-bold text-dark mb-0">
                    Create Payment Instructions
                  </h1>
                  <button
                    onClick={() => setShowDrafts(true)}
                    className="btn btn-outline-primary d-flex align-items-center"
                  >
                    <FileText className="me-2" size={18} />
                    View Drafts
                  </button>
                </div>
                <p className="text-muted mt-2 mb-0">
                  Set up your payment instructions with detailed beneficiary information
                </p>
              </div>

              <div className="mb-4">
                <InstructionDetails
                  instructionDetails={instructionDetails}
                  updateInstructionDetails={updateInstructionDetails}
                  errors={errors.instruction}
                />
              </div>

              <div className="mb-4">
                <PaymentDetailsTable
                  rows={currentRows}
                  updateRow={updateRow}
                  addRow={addRow}
                  removeRow={removeRow}
                  errors={currentRowErrors}
                  currentPage={currentPage}
                  totalPages={totalPages}
                  onPageChange={handlePageChange}
                  canAddMore={canAddMore}
                />
              </div>

              <div className="d-flex justify-content-end gap-3 mt-4">
                <button
                  onClick={handleDraft}
                  className="btn btn-secondary d-inline-flex align-items-center px-4 py-2"
                >
                  <Save className="me-2" style={{ width: '20px', height: '20px' }} />
                  Save Draft
                </button>
                <button
                  onClick={submitTransaction}
                  className="btn btn-success d-inline-flex align-items-center px-4 py-2"
                >
                  <Send className="me-2" style={{ width: '20px', height: '20px' }} />
                  Submit Transaction
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default PaymentForm;
